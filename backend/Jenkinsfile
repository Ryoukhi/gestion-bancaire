pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'JDK17'
    }

    environment {
        SONAR_TOKEN = credentials('sonarqube-token')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'üì• R√©cup√©ration du code source...'
                checkout scm
            }
        }

        stage('Build') {
            steps {
                dir('backend') {
                    echo 'üî® Compilation du projet...'
                    bat 'mvn clean compile'
                }
            }
        }

        stage('Unit Tests & Coverage') {
            steps {
                dir('backend') {
                    echo 'üß™ Ex√©cution des tests et g√©n√©ration de la couverture...'
                    bat 'mvn test'
                }
            }
            post {
                always {
                    dir('backend') {
                        // Publication des r√©sultats des tests
                        junit testResults: '**/target/surefire-reports/*.xml', allowEmptyResults: true

                        // Publication de la couverture JaCoCo
                        jacoco(
                            execPattern: 'target/jacoco.exec',
                            classPattern: 'target/classes',
                            sourcePattern: 'src/main/java',
                            exclusionPattern: '**/config/**,**/dto/**,**/entity/**'
                        )
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('backend') {
                    script {
                        echo 'üìä Analyse SonarQube en cours...'

                        // Tentative avec le plugin Maven (version du pom.xml)
                        try {
                            withSonarQubeEnv('SonarQube') {
                                bat """
                                    mvn sonar:sonar ^
                                      -Dsonar.token=%SONAR_TOKEN%
                                """
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è √âchec de l'analyse SonarQube avec le plugin Maven 4.0.0.4121"
                            echo "Erreur: ${e.message}"

                            // Fallback: essayer avec une version stable
                            echo "üîÑ Tentative avec la version 3.9.1.2184..."
                            withSonarQubeEnv('SonarQube') {
                                bat """
                                    mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.9.1.2184:sonar ^
                                      -Dsonar.projectKey=com.eadl:backend ^
                                      -Dsonar.host.url=http://localhost:9000 ^
                                      -Dsonar.token=%SONAR_TOKEN% ^
                                      -Dsonar.java.coveragePlugin=jacoco ^
                                      -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    echo 'üö¶ V√©rification du Quality Gate SonarQube...'
                    timeout(time: 5, unit: 'MINUTES') {
                        try {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate status: ${qg.status}"
                                // Ne pas √©chouer le build, juste un warning
                                unstable(message: "Quality Gate failed: ${qg.status}")
                            } else {
                                echo '‚úÖ Quality Gate passed!'
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Impossible de r√©cup√©rer le Quality Gate: ${e.message}"
                            echo "Le build continue sans v√©rification du Quality Gate"
                        }
                    }
                }
            }
        }

        stage('Package') {
            steps {
                dir('backend') {
                    echo 'üì¶ Cr√©ation du package JAR...'
                    bat 'mvn package -DskipTests'
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                dir('backend') {
                    echo 'üìÅ Archivage des artefacts...'
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true, allowEmptyArchive: true
                }
            }
        }
    }

    post {
        always {
            echo 'üßπ Nettoyage de l\'espace de travail...'
            cleanWs()
        }
        success {
            echo '''
            ====================================
            ‚úÖ BUILD R√âUSSI !
            ====================================
            üìä Analyse SonarQube termin√©e
            üì¶ Artefacts cr√©√©s et archiv√©s
            ====================================
            '''
        }
        failure {
            echo '''
            ====================================
            ‚ùå BUILD √âCHOU√â !
            ====================================
            Consultez les logs ci-dessus
            ====================================
            '''
        }
        unstable {
            echo '''
            ====================================
            ‚ö†Ô∏è BUILD INSTABLE
            ====================================
            Quality Gate non satisfait ou tests instables
            ====================================
            '''
        }
    }
}